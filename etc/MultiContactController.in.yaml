---
# If true, the FSM transitions are managed by an external tool
Managed: false
# If true and the FSM is self-managed, transitions should be triggered
StepByStep: true
# Change idle behaviour, if true the state is kept until transition,
# otherwise the FSM holds the last state until transition
IdleKeepState: true
# Where to look for state libraries
StatesLibraries:
  - "@MC_STATES_DEFAULT_INSTALL_PREFIX@"
  - "@STATES_INSTALL_PREFIX@/@PROJECT_NAME@/states"
# Where to look for state files
StatesFiles:
  - "@MC_STATES_DEFAULT_INSTALL_PREFIX@/data"
  - "@STATES_INSTALL_PREFIX@/@PROJECT_NAME@/states/data"
# If true, state factory will be more verbose
VerboseStateFactory: false
# Additional robots to load
robots:
  ground:
    module: env/ground
# General constraints, always on
constraints:
  - type: contact
  - type: kinematics
    damper: [0.1, 0.01, 0.5]
  - type: compoundJoint
# Collision constraint
collisions:
  - type: collision
    useMinimal: true
# Initial set of contacts
contacts: []

# Implement some additional text states
states:
  MCC::Initial_:
    base: MCC::Initial
    configs:
      gripperCommands:
        - name: l_gripper
          opening: 1.0
        - name: r_gripper
          opening: 1.0

  MCC::ConfigMotion_:
    base: MCC::ConfigMotion
    configs:
      baseTime: Relative
      stepCommandList:
        # - limb: LeftFoot
        #   type: Add
        #   startTime: 2.0
        #   endTime: 3.0
        #   pose:
        #     translation: [0.2, 0.1, 0]
        #   constraint:
        #     type: Surface
        #     fricCoeff: 0.5
        # - limb: RightFoot
        #   type: Add
        #   startTime: 3.5
        #   endTime: 4.5
        #   pose:
        #     translation: [0.4, -0.1, 0]
        #   constraint:
        #     type: Surface
        #     fricCoeff: 0.5
        # - limb: LeftFoot
        #   type: Add
        #   startTime: 5.0
        #   endTime: 6.0
        #   pose:
        #     translation: [0.6, 0.1, 0]
        #   constraint:
        #     type: Surface
        #     fricCoeff: 0.5
        # - limb: RightFoot
        #   type: Add
        #   startTime: 6.5
        #   endTime: 7.5
        #   pose:
        #     translation: [0.8, -0.1, 0]
        #   constraint:
        #     type: Surface
        #     fricCoeff: 0.5
        # - limb: LeftFoot
        #   type: Add
        #   startTime: 8.0
        #   endTime: 9.0
        #   pose:
        #     translation: [1.0, 0.1, 0]
        #   constraint:
        #     type: Surface
        #     fricCoeff: 0.5
        # - limb: RightFoot
        #   type: Add
        #   startTime: 9.5
        #   endTime: 10.5
        #   pose:
        #     translation: [1.2, -0.1, 0]
        #   constraint:
        #     type: Surface
        #     fricCoeff: 0.5
        # - limb: LeftFoot
        #   type: Add
        #   startTime: 11.0
        #   endTime: 12.0
        #   pose:
        #     translation: [1.4, 0.1, 0]
        #   constraint:
        #     type: Surface
        #     fricCoeff: 0.5
        # - limb: RightFoot
        #   type: Add
        #   startTime: 12.5
        #   endTime: 13.5
        #   pose:
        #     translation: [1.6, -0.1, 0]
        #   constraint:
        #     type: Surface
        #     fricCoeff: 0.5
        - limb: LeftFoot
          type: Add
          startTime: 2.0
          endTime: 4.0
          pose:
            translation: [0.2, 0.1, 0]
          constraint:
            type: Surface
            fricCoeff: 0.5
        - limb: RightFoot
          type: Add
          startTime: 6.0
          endTime: 8.0
          pose:
            translation: [0.4, -0.1, 0]
          constraint:
            type: Surface
            fricCoeff: 0.5
        - limb: LeftHand
          pose:
            translation: [0.4, 0.3, 0.75]
            rotation: [3.141592653589793, 0, 0]
          swingCommand:
            type: Add
            startTime: 6.0
            endTime: 8.0
            config:
              withdrawOffset: [0, 0, -0.06]
              approachOffset: [0, 0, -0.06]
              swingOffset:  [0, 0, -0.12]
          contactCommandList:
            - time: 6.0
              constraint: {}
            - time: 8.0
              constraint:
                type: Empty
            - time: 9.0
              constraint:
                type: Grasp
                fricCoeff: 0.5
          gripperCommandList:
            - time: 8.0
              name: l_gripper
              config:
                opening: 0.0
        # - limb: LeftHand
        #   type: Add
        #   startTime: 6.0
        #   endTime: 8.0
        #   pose:
        #     translation: [0.4, 0.3, 0.75]
        #     rotation: [3.141592653589793, 0, 0]
        #   constraint:
        #     type: Surface
        #     fricCoeff: 0.5
        #   swingConfig:
        #     withdrawOffset: [0, 0, -0.06]
        #     approachOffset: [0, 0, -0.06]
        #     swingOffset:  [0, 0, -0.12]
        - limb: LeftFoot
          type: Add
          startTime: 10.0
          endTime: 12.0
          pose:
            translation: [0.6, 0.1, 0]
          constraint:
            type: Surface
            fricCoeff: 0.5
        - limb: RightFoot
          type: Add
          startTime: 14.0
          endTime: 16.0
          pose:
            translation: [0.8, -0.1, 0]
          constraint:
            type: Surface
            fricCoeff: 0.5
        - limb: LeftHand
          swingCommand:
            type: Remove
            startTime: 14.0
            endTime: 16.0
            config:
              withdrawOffset: [0, 0, -0.06]
              approachOffset: [0, 0, -0.06]
              swingOffset:  [0, 0, -0.12]
          contactCommandList:
            - time: 13.0
              constraint:
                type: Empty
            - time: 14.0
              constraint: {}
          gripperCommandList:
            - time: 13.0
              name: l_gripper
              config:
                opening: 1.0
        # - limb: LeftHand
        #   type: Remove
        #   startTime: 14.0
        #   endTime: 16.0
        #   swingConfig:
        #     withdrawOffset: [0, 0, -0.06]
        #     approachOffset: [0, 0, -0.06]
        #     swingOffset:  [0, 0, -0.12]

  MCC::Main_:
    base: Parallel
    states: [MCC::ConfigMotion_]

# Transitions map
transitions:
  - [MCC::Initial_, OK, MCC::Main_, Auto]
# Initial state
init: MCC::Initial_

ObserverPipelines:
  name: MainObserverPipeline
  gui: true
  observers:
    - type: Encoder
    - type: Attitude
      config:
        KalmanFilter:
          gyr_cov: 1e-6
    - type: KinematicInertial
      config:
        anchorFrame:
          maxAnchorFrameDiscontinuity: 0.05 # [m]

controllerName: MCC

PostureTask:
  stiffness: 10

CoMTask:
  type: com
  stiffness: [1000.0, 1000.0, 1000.0]
  weight: 1000.0

BaseOrientationTask:
  type: orientation
  stiffness: 300.0
  weight: 500.0

MomentumTask:
  type: momentum
  stiffness: 1.0
  weight: 0.0

LimbTaskList:
  - type: firstOrderImpedance
    limb: LeftFoot
    frame: LeftFootCenter
    cutoffPeriod: 0.01
    weight: 1000.0
  - type: firstOrderImpedance
    limb: RightFoot
    frame: RightFootCenter
    cutoffPeriod: 0.01
    weight: 1000.0
  - type: firstOrderImpedance
    limb: LeftHand
    frame: LeftGripper
    cutoffPeriod: 0.01
    weight: 1000.0
  - type: firstOrderImpedance
    limb: RightHand
    frame: RightGripper
    cutoffPeriod: 0.01
    weight: 1000.0

LimbManagerSet:
  name: LimbManagerSet
  LimbManager:
    default:
      impedanceGains:
        SingleContact:
          damper:
            linear: [300, 300, 300]
            angular: [100, 100, 100]
          spring:
            linear: [1125, 1125, 1125]
            angular: [0, 0, 2000]
          wrench:
            linear: [0, 0, 0]
            angular: [1, 1, 0]
        MultiContact:
          damper:
            linear: [1e4, 1e4, 1e4]
            angular: [100, 100, 100]
          spring:
            linear: [0, 0, 0]
            angular: [0, 0, 2000]
          wrench:
            linear: [1, 1, 1]
            angular: [1, 1, 0]
        Swing:
          damper:
            linear: [300, 300, 300]
            angular: [40, 40, 40]
          spring:
            linear: [2250, 2250, 2250]
            angular: [400, 400, 400]
          wrench:
            linear: [0, 0, 0]
            angular: [0, 0, 0]
    LeftHand:
      impedanceGains:
        MultiContact:
          damper:
            linear: [1e3, 1e3, 1e3]
            angular: [100, 100, 100]
          spring:
            linear: [0, 0, 0]
            angular: [0, 0, 2000]
          wrench:
            linear: [1, 1, 1]
            angular: [1, 1, 0]
    RightHand:
      impedanceGains:
        MultiContact:
          damper:
            linear: [1e3, 1e3, 1e3]
            angular: [100, 100, 100]
          spring:
            linear: [0, 0, 0]
            angular: [0, 0, 2000]
          wrench:
            linear: [1, 1, 1]
            angular: [1, 1, 0]

CentroidalManager:
  name: CentroidalManager
  nominalCentroidalPose:
    translation: [0.0, 0.0, 0.85]
  limbWeightListForRefData:
    LeftFoot: 1.0
    RightFoot: 1.0
  limbWeightListForAnchorFrame:
    LeftFoot: 1.0
    RightFoot: 1.0
  centroidalGainP:
    linear: [1000, 1000, 10000]
    angular: [750, 750, 750]
  centroidalGainD:
    linear: [200, 200, 200]
    angular: [150, 150, 150]
  useActualStateForMpc: false
  enableCentroidalFeedback: true
  useOnlyFootForAnchorFrame: true
  useTargetPoseForControlRobotAnchorFrame: true
  useActualComForWrenchDist: false
  wrenchDistConfig:
    wrenchWeight:
      linear: [1.0, 1.0, 1.0]
      angular: [1.0, 1.0, 1.0]
    regularWeight: 1e-8
    ridgeForceMinMax: [3, 1000] # [N]

  # DDP
  method: DDP
  horizonDuration: 2.0 # [sec]
  horizonDt: 0.05 # [sec]
  ddpMaxIter: 1
  mpcWeightParam:
    runningPos: [10.0, 10.0, 10.0]
    runningLinearMomentum: [1e-6, 1e-6, 1e-6]
    runningAngularMomentum: [1e-3, 1e-3, 1e-3]
    runningForce: 5e-6
    terminalPos: [10.0, 10.0, 10.0]
    terminalLinearMomentum: [1e-6, 1e-6, 1e-6]
    terminalAngularMomentum: [1e-3, 1e-3, 1e-3]

Contacts:
  Surface:
    - name: LeftFoot
      vertices: [[-0.1, -0.04, 0.0], [-0.1, 0.04, 0.0], [0.1, 0.04, 0.0], [0.1, -0.04, 0.0]]
    - name: RightFoot
      vertices: [[-0.1, -0.04, 0.0], [-0.1, 0.04, 0.0], [0.1, 0.04, 0.0], [0.1, -0.04, 0.0]]
    - name: LeftHand
      vertices: [[0, 0, 0]]
    - name: RightHand
      vertices: [[0, 0, 0]]

  Grasp:
    - name: LeftHand
      vertices:
        - translation: [0, 0, -0.05]
        - translation: [0, 0, 0.05]
          rotation: [0, 3.141592653589793, 0]
    - name: RightHand
      vertices:
        - translation: [0, 0, -0.05]
        - translation: [0, 0, 0.05]
          rotation: [0, 3.141592653589793, 0]

  Initial:
    LeftFoot:
      type: Surface
      fricCoeff: 0.5
    RightFoot:
      type: Surface
      fricCoeff: 0.5


OverwriteConfigKeys: [NoSensors]

OverwriteConfigList:
  NoSensors:
    LimbManagerSet:
      LimbManager:
        default:
          impedanceGains:
            SingleContact:
              wrench:
                linear: [0, 0, 0]
                angular: [0, 0, 0]
            MultiContact:
              wrench:
                linear: [0, 0, 0]
                angular: [0, 0, 0]
        LeftHand:
          impedanceGains:
            MultiContact:
              wrench:
                linear: [0, 0, 0]
                angular: [0, 0, 0]
        RightHand:
          impedanceGains:
            MultiContact:
              wrench:
                linear: [0, 0, 0]
                angular: [0, 0, 0]

  jvrc1:
    PostureTask:
      jointWeights:
        WAIST_R: 10
        WAIST_P: 10
      # For arm swing
      jointGains:
        - jointName: R_SHOULDER_P
          stiffness: 400
        - jointName: L_SHOULDER_P
          stiffness: 400

    CoMTask:
      activeJoints: [
      "Root",
      "R_HIP_Y", "R_HIP_R", "R_HIP_P", "R_KNEE", "R_ANKLE_P", "R_ANKLE_R",
      "L_HIP_Y", "L_HIP_R", "L_HIP_P", "L_KNEE", "L_ANKLE_P", "L_ANKLE_R"]

    BaseOrientationTask:
      frame: WAIST_R_S
